<?php
/**
 * Envio AutomÃ¡tico do Upsell (Dieta + Receitas)
 * --------------------------------------------------------
 * E-mail: contato@dietapronta.online
 * SMTP: mail.dietapronta.online (porta 465, SSL)
 * Hospedagem: HostGator
 * --------------------------------------------------------
 * Retorna JSON sempre:
 * { "ok": true, "message": "E-mail enviado com sucesso!" }
 */

// === CORS ===
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Authorization");
header('Content-Type: application/json; charset=utf-8');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
  http_response_code(204);
  exit;
}

// === DEPURAÃ‡ÃƒO OPCIONAL ===
ini_set('display_errors', 0);
error_reporting(E_ALL);

// === Caminhos do PHPMailer ===
require __DIR__ . '/PHPMailer/PHPMailer.php';
require __DIR__ . '/PHPMailer/SMTP.php';
require __DIR__ . '/PHPMailer/Exception.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

// === CONFIGURAÃ‡ÃƒO DO SMTP ===
$MAIL_HOST = 'mail.dietapronta.online';
$MAIL_USER = 'contato@dietapronta.online';
$MAIL_PASS = 'italo1607';
$MAIL_PORT = 465;
$MAIL_FROM = 'contato@dietapronta.online';
$MAIL_NAME = 'Dieta Pronta Online';

// === RECEBE DADOS ===
$raw = file_get_contents("php://input");
$data = json_decode($raw, true);
if (!$data || !is_array($data)) $data = $_POST;

$email = trim($data['email'] ?? '');
$dieta_raw = trim($data['dieta'] ?? '');
$nome = trim($data['nome'] ?? 'Cliente');

if (!$email || !filter_var($email, FILTER_VALIDATE_EMAIL)) {
  echo json_encode(['ok' => false, 'error' => 'email_missing_or_invalid']);
  exit;
}

// ======================================================================
// MAPA DE DIETAS (Link do PDF)
// ======================================================================
$mensagens = [
    'Low Carb' => 'https://dietapronta.online/pdfs/Dieta_Low_Carb.pdf',
    'CetogÃªnica' => 'https://dietapronta.online/pdfs/Dieta_Cetogenica.pdf',
    'FlexÃ­vel' => 'https://dietapronta.online/pdfs/Dieta_Flexivel.pdf',
    'MediterrÃ¢nea' => 'https://dietapronta.online/pdfs/Dieta_Mediterranea.pdf',
    '200 Receitas SaudÃ¡veis' => 'https://dietapronta.online/pdfs/200_Receitas_Saudaveis.pdf'
];

// === MAPEAMENTO DE PALAVRAS-CHAVE ===
$dietas_mapeadas = [
    'low carb' => 'Low Carb',
    'cetogenica' => 'CetogÃªnica',
    'flexivel' => 'FlexÃ­vel',
    'mediterranea' => 'MediterrÃ¢nea',
    'ectomorfo' => 'Low Carb',
    'mesomorfo' => 'FlexÃ­vel',
    'endomorfo' => 'CetogÃªnica'
];

// === ENCONTRA A DIETA CORRETA (IGNORA EMOJI E CASE) ===
$dieta_encontrada = null;
$dieta_limpa = strtolower(preg_replace('/[^\w\s]/', '', $dieta_raw));

foreach ($dietas_mapeadas as $chave => $nome) {
    if (str_contains($dieta_limpa, $chave)) {
        $dieta_encontrada = $nome;
        break;
    }
}

if (!$dieta_encontrada && isset($mensagens[$dieta_raw])) {
    $dieta_encontrada = $dieta_raw;
}

$dieta_exibicao = $dieta_raw;
$dieta = $dieta_encontrada ?? 'Desconhecida';

// === MONTA LINKS ===
$link_plano_html = '';
$link_receitas_html = '';
$alt_text = "Seu plano $dieta_exibicao estÃ¡ pronto.";

if ($dieta !== 'Desconhecida' && isset($mensagens[$dieta])) {
    $link = $mensagens[$dieta];
    $link_plano_html = '<p><a href="' . $link . '" target="_blank" style="color:#1a73e8;font-weight:bold;text-decoration:none;">Baixar Plano ' . $dieta . ' (PDF)</a></p>';
    $alt_text .= " Acesse: $link";
} else {
    $link_plano_html = '<p><strong style="color:red;">[ERRO] Dieta nÃ£o reconhecida: "' . htmlspecialchars($dieta_raw, ENT_QUOTES) . '"</strong></p>';
}

// ðŸ”¥ No upsell, sempre adiciona o PDF de receitas
$link_rec = $mensagens['200 Receitas SaudÃ¡veis'];
$link_receitas_html = '<p><a href="' . $link_rec . '" target="_blank" style="color:#1a73e8;font-weight:bold;text-decoration:none;">Baixar 200 Receitas SaudÃ¡veis (PDF)</a></p>';
$alt_text .= " | Receitas: $link_rec";

// === CORPO DO E-MAIL ===
$body = '
<h2>ðŸŽ‰ Obrigado por adquirir o Combo Completo!</h2>
<p>OlÃ¡, <b>' . htmlspecialchars($nome, ENT_QUOTES) . '</b>!</p>
<p>Conforme suas respostas no quiz, enviamos abaixo seu plano <b>' . htmlspecialchars($dieta_exibicao, ENT_QUOTES) . '</b> e o bÃ´nus exclusivo de receitas!</p>
<p><strong>Clique nos links abaixo para baixar seus arquivos:</strong></p>' . $link_plano_html . $link_receitas_html . '
<p>ðŸ’š <b>Dieta Pronta Online</b></p>';

$body = trim(str_replace(["\n", "\r", "\t"], '', $body));

// === ENVIO ===
$mail = new PHPMailer(true);
$response = [];
try {
    $mail->isSMTP();
    $mail->Host       = $MAIL_HOST;
    $mail->SMTPAuth   = true;
    $mail->Username   = $MAIL_USER;
    $mail->Password   = $MAIL_PASS;
    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
    $mail->Port       = $MAIL_PORT;
    $mail->CharSet    = 'UTF-8';
    $mail->Encoding   = '8bit';

    $mail->setFrom($MAIL_FROM, $MAIL_NAME);
    $mail->addAddress($email);
    $mail->Subject = 'ðŸ“¦ Seu Combo Completo â€“ Plano + Receitas (Dieta Pronta Online)';
    $mail->isHTML(true);
    $mail->Body    = $body;
    $mail->AltBody = $alt_text;

    file_put_contents(__DIR__ . '/logs/last_email_upsell.html', $body);

    $mail->send();

    $response['ok'] = true;
    $response['message'] = 'E-mail de upsell enviado com sucesso!';
    $response['to'] = $email;
    $response['dieta_raw'] = $dieta_raw;
    $response['dieta_mapeada'] = $dieta;
} catch (Exception $e) {
    $response['ok'] = false;
    $response['error'] = $mail->ErrorInfo ?: $e->getMessage();
}

// === LOG ===
$log_dir = __DIR__ . '/logs';
if (!is_dir($log_dir)) mkdir($log_dir, 0755, true);
file_put_contents(
    "$log_dir/envios_upsell.txt",
    sprintf("[%s] EMAIL: %s | RAW: %s | MAPEADA: %s | STATUS: %s\n",
        date('Y-m-d H:i:s'),
        $email,
        $dieta_raw,
        $dieta,
        $response['ok'] ? 'OK' : 'ERRO'
    ),
    FILE_APPEND
);

if (!headers_sent()) {
    header('Content-Type: application/json; charset=utf-8');
}
echo json_encode($response, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
