<script>
(function(){
  const MP_PUBLIC_KEY = "APP_USR-87cc4830-2ac4-410d-82b8-f295612a75b0";
  const MP_ENDPOINT = "https://dietapronta.online/api/mp-preference";
  const CHECK_STATUS = "/api/mp-check-status";
  const HOME_APPROVED = "https://dietapronta.online/approved";
  const HOME_FAILURE = "https://dietapronta.online/?status=failure#quiz";

  function $(id){ return document.getElementById(id); }
  function showBanner(texto, classes){
    const banner = $("statusBanner");
    banner.textContent = texto;
    banner.className = "mt-4 mb-2 rounded-xl px-4 py-3 text-sm border " + classes;
    banner.classList.remove("hidden");
  }

  // Recupera ref
  function getQS(k){ return new URLSearchParams(location.search).get(k) || ''; }
  let ref = getQS("ref") || "";
  if (!ref) {
    try { ref = localStorage.getItem("mp_external_ref") || ""; } catch(e){}
  }
  if (!ref) {
    ref = 'ref-' + Date.now() + '-' + Math.random().toString(36).substr(2,6);
    try { localStorage.setItem("mp_external_ref", ref); } catch(e){}
  }
  const u = new URL(location.href);
  u.searchParams.set("ref", ref);
  history.replaceState(null, "", u.toString());

  // Dados do cliente
  let customer_name = "", customer_email = "", customer_whats = "";
  try {
    customer_name = localStorage.getItem("lead_nome") || getQS("nome") || "";
    customer_email = localStorage.getItem("lead_email") || getQS("email") || "";
    customer_whats = localStorage.getItem("lead_whats") || getQS("whats") || "";
  } catch(e){}

  const mp = new MercadoPago(MP_PUBLIC_KEY, { locale: "pt-BR" });
  let bricksBuilder = null;
  let pollTimer = null;

  // Cria preferência
  fetch(MP_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      valor: 9.90,
      titulo: "Plano de Dieta Completo",
      external_reference: ref,
      customer_name: customer_name,
      customer_email: customer_email,
      customer_whatsapp: customer_whats
    })
  })
  .then(r => r.json().catch(() => ({})))
  .then(data => {
    if (!data.id) throw new Error("Preferência inválida");

    bricksBuilder = mp.bricks();

    // Wallet Brick (Pix, Boleto, Cartão rápido)
    const walletBrick = bricksBuilder.create("wallet", "walletBrick_container", {
      initialization: { preferenceId: data.id },
      customization: {
        texts: { action: "pay", valueProp: "security" },
        visual: { buttonBackground: "black", borderRadius: "6px" }
      },
      callbacks: {
        onSubmit: () => {
          showBanner("Processando pagamento... Aguarde.", "bg-blue-50 border-blue-300 text-blue-800");
        },
        onReady: () => {
          console.log("Wallet Brick carregado");
        },
        onError: (error) => {
          console.error("Wallet error:", error);
          showBanner("Erro no botão de pagamento. Tente novamente.", "bg-rose-50 border-rose-300 text-rose-800");
        }
      }
    });

    // Card Payment Brick (campos completos)
    const cardBrick = bricksBuilder.create("cardPayment", "cardPaymentBrick_container", {
      initialization: { preferenceId: data.id },
      customization: {
        visual: { style: { theme: "default" } },
        paymentMethods: { maxInstallments: 1 }
      },
      callbacks: {
        onSubmit: (formData) => {
          showBanner("Processando cartão... Aguarde.", "bg-blue-50 border-blue-300 text-blue-800");
          return new Promise((resolve, reject) => {
            fetch("https://dietapronta.online/api/mp-process-payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token: formData.token,
                issuer_id: formData.issuer_id,
                payment_method_id: formData.payment_method_id,
                transaction_amount: 9.90,
                installments: 1,
                payer: { email: customer_email },
                external_reference: ref
              })
            })
            .then(r => r.json())
            .then(res => {
              if (res.status === "approved") {
                triggerApproved();
                resolve();
              } else {
                showBanner("Pagamento não aprovado. Tente outro método.", "bg-rose-50 border-rose-300 text-rose-800");
                reject(res);
              }
            })
            .catch(err => {
              showBanner("Erro ao processar cartão. Tente novamente.", "bg-rose-50 border-rose-300 text-rose-800");
              reject(err);
            });
          });
        }
      }
    });

    showBanner("Preencha os dados e clique em Pagar. Pix é instantâneo!", "bg-amber-50 border-amber-300 text-amber-800");
    startPolling();
  })
  .catch(err => {
    console.error(err);
    showBanner("Erro ao carregar pagamento. Tente novamente.", "bg-rose-50 border-rose-300 text-rose-800");
  });

  // Função central de aprovação
  function triggerApproved() {
    if (pollTimer) clearInterval(pollTimer);
    showBanner("Pagamento aprovado! Redirecionando para seu plano...", "bg-emerald-50 border-emerald-300 text-emerald-800");
    setTimeout(() => {
      location.href = HOME_APPROVED;
    }, 1500);
  }

  // Polling reforçado (a cada 5 segundos)
  function startPolling(){
    checkNow();
    pollTimer = setInterval(checkNow, 5000); // Mais rápido!
  }

  async function checkNow(){
    try {
      const r = await fetch(CHECK_STATUS + "?ref=" + encodeURIComponent(ref));
      const data = await r.json();
      if (data?.found && data.status === "approved") {
        triggerApproved();
      }
    } catch(e){}
  }

  $("year").textContent = new Date().getFullYear();
})();
</script>
