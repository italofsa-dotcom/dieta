<script>
document.addEventListener("DOMContentLoaded", async function(){
  // === DADOS DO localStorage (mantÃ©m tudo que vocÃª jÃ¡ usa) ===
  const nome = localStorage.getItem('lead_nome') || '';
  const dietTitle = localStorage.getItem('diet_title') || localStorage.getItem('quiz_result_title') || '';
  const bodyType = localStorage.getItem('body_type') || localStorage.getItem('quiz_body_type') || '';
  const imcValue = localStorage.getItem('imc_value') || '';
  const imcLabel = localStorage.getItem('imc_label') || '';
  const desc = localStorage.getItem('quiz_result_desc') || '';
  const phoneRaw = localStorage.getItem('lead_whats') || '';
  const whatsapp = "5561999999999"; // seu nÃºmero de atendimento (mantido)

  // === ATUALIZA CAMPOS (igual ao seu cÃ³digo original) ===
  if(nome) document.getElementById('nomeSpan').textContent = nome + "!";
  document.getElementById('year').textContent = new Date().getFullYear();
  document.getElementById('infoNome').textContent = nome || '-';
  document.getElementById('infoDieta').textContent = dietTitle || 'Personalizada';
  document.getElementById('infoBodyType').textContent = bodyType || '---';
  document.getElementById('infoIMC').textContent = imcValue || '---';
  document.getElementById('infoIMCLabel').textContent = imcLabel ? "(" + imcLabel + ")" : '';
  document.getElementById('descSpan').textContent = desc;

  // === LINK DO BOTÃƒO (mantido) ===
  const msg = encodeURIComponent(
    `OlÃ¡! ðŸ˜Š\nMeu nome Ã© ${nome} e acabei de finalizar minha compra da *Dieta Pronta Online!*\n\nðŸ“‹ *Plano:* ${dietTitle || "Personalizado"} (${bodyType || "biotipo nÃ£o informado"})\nðŸ“Š *IMC:* ${imcValue || "-"} ${imcLabel ? "(" + imcLabel + ")" : ""}\n\nPoderia me enviar meu plano personalizado, por favor?`
  );
  const linkZap = `https://wa.me/${whatsapp}?text=${msg}`;
  document.getElementById('btnPlano').setAttribute('href', linkZap);

  // === FORMATA TELEFONE ===
  const formatPhone = (num) => {
    const cleaned = num.replace(/\D/g, '');
    if (cleaned.length >= 11) {
      return `(${cleaned.slice(2,4)}) ${cleaned.slice(4,9)}-${cleaned.slice(9,13)}`;
    }
    return cleaned;
  };
  const phone = phoneRaw.replace(/\D/g, '');

  // === ENVIO AUTOMÃTICO (via seu envio_dieta.php) ===
  const enviarPlano = async () => {
    if (!phone || !dietTitle) return;

    try {
      const res = await fetch('https://dietapronta.online/envio_dieta.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Referer': 'https://dietapronta.online'
        },
        body: JSON.stringify({
          phone: phone,
          dieta: dietTitle  // â† ENVIA A DIETA EXATA
        })
      });
      const data = await res.json();
      console.log('Enviado com sucesso:', data);
    } catch (err) {
      console.warn('Envio automÃ¡tico (continua mesmo com erro):', err);
    }
  };

  // === CONTAGEM REGRESSIVA + MENSAGEM (mantÃ©m seu #statusEnvio) ===
  const statusDiv = document.getElementById('statusEnvio');
  let count = 5;
  statusDiv.textContent = `Enviando plano para seu WhatsApp... ${count}`;

  // Inicia envio
  enviarPlano();

  const timer = setInterval(() => {
    count--;
    if (count > 0) {
      statusDiv.textContent = `Enviando plano para seu WhatsApp... ${count}`;
    } else {
      clearInterval(timer);
      statusDiv.textContent = `Enviado com sucesso para seu WhatsApp: ${formatPhone(phoneRaw)}`;
      statusDiv.style.animation = "none";
      statusDiv.style.background = "#d1fae5";
      statusDiv.style.color = "#065f46";
      statusDiv.style.boxShadow = "0 0 20px rgba(16,185,129,0.6)";
    }
  }, 1000);
});
</script>
