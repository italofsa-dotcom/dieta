<script>
document.addEventListener("DOMContentLoaded", function() {
  const MP_PUBLIC_KEY = "APP_USR-87cc4830-2ac4-410d-82b8-f295612a75b0";
  const MP_ENDPOINT   = "https://dietapronta.online/api/mp-preference";
  const CHECK_STATUS  = "https://italomelo.com/server/check_status.php";
  const HOME_UPSELL   = "https://dietapronta.online/upsell/?ref=";
  const $ = id => document.getElementById(id);

  // === PersonalizaÃ§Ã£o dinÃ¢mica ===
  const nome    = localStorage.getItem('lead_nome') || '';
  const imc     = localStorage.getItem('quiz_imc_value') || '';
  const biotipo = localStorage.getItem('quiz_result_body_name') || '';
  const personalizacao = document.getElementById('personalizacao');
  if (personalizacao) {
    personalizacao.innerHTML = `
      ${nome ? `<strong>${nome}</strong>,` : ''}
      de acordo com seu <strong>IMC ${imc || 'â€”'}</strong> e seu 
      <strong>biotipo ${biotipo || 'â€”'}</strong>, 
      criamos o plano ideal para vocÃª alcanÃ§ar excelentes resultados! ðŸ’ª
    `;
  }

  // === Contagem regressiva ===
  if ($('countdown')) {
    let timeLeft = 5 * 60;
    const countdownEl = $('countdown');
    const countdownBox = $('countdownBox');
    setInterval(() => {
      const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const s = String(timeLeft % 60).padStart(2, '0');
      countdownEl.textContent = `${m}:${s}`;
      if (timeLeft <= 60) countdownBox.classList.add("pulse");
      if (timeLeft <= 0) countdownEl.textContent = "00:00";
      timeLeft--;
    }, 1000);
  }

  // === Pagamento Mercado Pago ===
  const ref = 'ref-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
  try { localStorage.setItem('mp_external_ref', ref); } catch(e){}

  $('btnPagamento')?.addEventListener('click', async ev => {
    ev.preventDefault();
    const btn = $('btnPagamento');
    btn.disabled = true;
    btn.textContent = "Gerando pagamento...";
    try {
      const r = await fetch(MP_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          valor: 19.90,
          titulo: "Plano de Dieta Completo",
          external_reference: ref,
          customer_name: nome,
          customer_email: localStorage.getItem('lead_email') || '',
          customer_whatsapp: localStorage.getItem('lead_whats') || '',
          body_type: biotipo
        })
      });
      const data = await r.json();
      if (!data || !data.id) throw new Error("Falha ao criar preferÃªncia.");

      const mp = new MercadoPago(MP_PUBLIC_KEY, { locale: "pt-BR" });
      mp.checkout({
        preference: { id: data.id },
        autoOpen: true,
        render: { container: "#mp-checkout", label: "Pagar R$ 19,90" }
      });

      btn.textContent = "Abrindo pagamento...";
      startPolling(ref, btn);
    } catch (e) {
      console.error(e);
      btn.textContent = "Erro, tente novamente";
    }
    btn.disabled = false;
  });

  function startPolling(ref, btn) {
    let tries = 0;
    const timer = setInterval(async () => {
      tries++;
      try {
        const res = await fetch(`${CHECK_STATUS}?ref=${encodeURIComponent(ref)}&t=${Date.now()}`);
        const data = await res.json();
        if (data && data.found && data.status?.toLowerCase() === "approved") {
          clearInterval(timer);
          btn.textContent = "âœ… Pagamento aprovado! Redirecionando...";
          setTimeout(() => window.location.href = HOME_UPSELL + encodeURIComponent(ref), 2000);
        }
      } catch (e) { console.warn(e); }
      if (tries > 40) clearInterval(timer);
    }, 5000);
  }

  // === Rolagem suave atÃ© a galeria ===
  document.getElementById('btnResultados')?.addEventListener('click', () => {
    document.querySelector('.galeria')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
});
</script>
