<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function getParam(k){ try{ return new URLSearchParams(location.search).get(k) || ''; }catch(_){ return ''; } }

  // Carrega dados bÃ¡sicos do lead
  var ref   = getParam('ref')   || localStorage.getItem('mp_external_ref') || '';
  var nome  = getParam('nome')  || localStorage.getItem('lead_nome') || '';
  var email = getParam('email') || localStorage.getItem('lead_email') || '';
  var whats = getParam('whats') || localStorage.getItem('lead_whats') || '';

  // Carrega resultado do quiz
  var resultTitle = localStorage.getItem('quiz_result_title') || localStorage.getItem('quiz_diet_title') || '';
  var resultDesc  = localStorage.getItem('quiz_result_desc') || '';
  var bodyType    = localStorage.getItem('quiz_body_type') || localStorage.getItem('quiz_biotype') || '';
  var imcVal      = localStorage.getItem('quiz_imc_value');
  var imcLabel    = localStorage.getItem('quiz_imc_label') || '';

  // Exibe no texto principal
  if(nome){ $('nomeSpan').textContent = nome; }

  if(imcVal){
    var v = parseFloat(imcVal);
    var tone = {
      'abaixo do peso': 'Vamos reforÃ§ar densidade nutricional sem exageros.',
      'faixa saudÃ¡vel': 'Excelente! Vamos preservar seu bem-estar.',
      'sobrepeso': 'Vamos reduzir gordura com seguranÃ§a.',
      'obesidade leve': 'Nossa prioridade Ã© conforto e progresso consistente.'
    };
    $('imcInfo').innerHTML = "<span class='badge bg-emerald-100 text-emerald-800'>IMC "+v+" â€” "+imcLabel+"</span> <span class='ml-2 text-slate-700'>"+(tone[imcLabel]||'Plano ajustado para vocÃª.')+"</span>";
    $('imcInfo').classList.remove('hidden');
  }

  if(resultTitle){ $('planoSpan').textContent = resultTitle.replace(/^ðŸŽ¯\s*/,''); }
  if(resultDesc){ $('descSpan').textContent = resultDesc; }

  // ðŸ”¹ Monta URL para /pagamento com dados completos
  var payUrl = new URL('/pagamento/', location.origin);
  if(ref)   payUrl.searchParams.set('ref', ref);
  if(nome)  payUrl.searchParams.set('nome', nome);
  if(email) payUrl.searchParams.set('email', email);
  if(whats) payUrl.searchParams.set('whats', whats);

  // Tipo de dieta + biotipo + IMC
  if(resultTitle) payUrl.searchParams.set('diet_title', resultTitle);
  if(bodyType)    payUrl.searchParams.set('body_type', bodyType);
  if(imcVal)      payUrl.searchParams.set('imc_value', imcVal);
  if(imcLabel)    payUrl.searchParams.set('imc_label', imcLabel);

  // ðŸ”¹ Salva no localStorage para o pagamento
  try {
    if(resultTitle) localStorage.setItem('diet_title', resultTitle);
    if(bodyType)    localStorage.setItem('body_type', bodyType);
    if(imcVal)      localStorage.setItem('imc_value', imcVal);
    if(imcLabel)    localStorage.setItem('imc_label', imcLabel);
  } catch(e){}

  $('btnPagamento').setAttribute('href', payUrl.toString());
  $('btnContinuarTop').setAttribute('href', '#oferta');

  $('year').textContent = (new Date()).getFullYear();
})();
</script>
